<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Reviews - GymNest</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary: #E63946;
            --primary-600: #D32F2F;
            --secondary: #457B9D;
            --dark: #1D3557;
            --bg: #f8f9fa;
            --ink: #121212;
            --card-bg: #fff;
            --section-pad: 5rem 0;
            --border-radius: 12px;
            --shadow-1: 0 10px 25px rgba(0,0,0,.08);
            --shadow-2: 0 16px 40px rgba(0,0,0,.12);
        }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--ink); }
        .section { padding: var(--section-pad); }
        .page-header { padding: 5rem 0 3rem; background: linear-gradient(90deg, var(--dark) 0%, var(--secondary) 100%); color:#fff; text-align:center; position: relative;}
        .page-header::before { content: ''; position: absolute; top:0; left:0; right:0; bottom:0; background: rgba(0,0,0,0.1); z-index:-1; }
        .page-header h1 { font-weight: 800; margin-bottom: 1rem; }
        .page-subtitle { color:#cfd3da; font-size:1.25rem; max-width:600px; margin:0 auto; }

        .navbar { background: rgba(255,255,255,0.95) !important; backdrop-filter: blur(10px); box-shadow:0 2px 15px rgba(0,0,0,0.1);}
        .navbar-brand { font-weight: 800; }
        .navbar-nav .nav-link { color: var(--dark); font-weight: 500; transition: color 0.15s ease; }
        .navbar-nav .nav-link:hover, .navbar-nav .nav-link.active { color: var(--primary); }

        .table { background: var(--card-bg); }
        .table thead th { background-color: var(--primary-600) !important; color: #fff; border-color: var(--primary-600) !important; }
        .table-striped tbody tr:nth-of-type(odd) { background-color: rgba(69,123,157,.03); }
        .table-responsive { overflow-x:auto; }

        .badge { font-weight: 600; }
        .footer { background: var(--dark); color: #cfd3da; padding: 4rem 0 2rem; }
        .footer a { color: #cfd3da; text-decoration: none; }
        .footer a:hover { color: #fff; }
        .fade-in { animation: fadeIn 0.6s ease forwards; }
        @keyframes fadeIn { from { opacity:0; transform: translateY(20px);} to { opacity:1; transform:translateY(0);} }
    </style>
</head>
<body>

<!-- Navbar -->
<nav class="navbar navbar-expand-lg sticky-top shadow-sm">
    <div class="container">
        <a class="navbar-brand" href="index.html"><i class="fa-solid fa-dumbbell me-2"></i>GymNest</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#nav" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="nav">
            <ul class="navbar-nav ms-auto">
                <li class="nav-item"><a class="nav-link" href="index.html">Home</a></li>
                <li class="nav-item"><a class="nav-link active" href="user-reviews.html">My Reviews</a></li>
                <li class="nav-item dropdown d-none d-lg-inline-flex ms-lg-3" id="userDropdown"></li>
            </ul>
        </div>
    </div>
</nav>

<!-- Page Header -->
<header class="page-header">
    <div class="container">
        <h1>My Reviews</h1>
        <p class="page-subtitle">See all the feedback you've submitted.</p>
    </div>
</header>

<!-- Reviews Section -->
<section class="section">
    <div class="container">
        <div class="card shadow-lg p-4">
            <h2 class="mb-4 text-center">Your Review Details</h2>
            <div class="table-responsive">
                <table class="table table-striped table-bordered align-middle">
                    <thead>
                    <tr>
                        <th>#</th>
                        <th>Rating</th>
                        <th>Comment</th>
                        <th>Submitted On</th>
                        <th>Actions</th>
                    </tr>
                    </thead>
                    <tbody id="userReviewsTableBody">
                    <tr><td colspan="5" class="text-center">Loading your reviews...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</section>



<!-- Footer -->
<footer class="footer mt-5 pt-5 pb-4">
    <div class="container">
        <div class="row g-4">
            <div class="col-md-4">
                <div class="brand mb-2"><i class="fa-solid fa-dumbbell me-2 text-warning"></i>GymNest</div>
                <p>Stronger every day — with expert coaching and a community that has your back.</p>
            </div>
            <div class="col-md-4">
                <h6 class="text-white">Quick Links</h6>
                <ul class="list-unstyled">
                    <li><a href="index.html">Home</a></li>
                    <li><a href="index.html#about">About</a></li>
                    <li><a href="index.html#classes">Classes</a></li>
                    <li><a href="index.html#coaches">Coaches</a></li>
                    <li><a href="index.html#locations">Locations</a></li>
                    <li><a href="index.html#contact">Contact</a></li>
                </ul>
            </div>
            <div class="col-md-4">
                <h6 class="text-white">Contact</h6>
                <p><i class="fa-solid fa-location-dot me-2"></i> 45 King Street, Colombo</p>
                <p><i class="fa-solid fa-phone me-2"></i> +94 77 123 4567</p>
                <p><i class="fa-solid fa-envelope me-2"></i> hello@gymnest.fit</p>
            </div>
        </div>
        <div class="copyright mt-4 pt-3 text-center">
            <span>© <span class="year"></span> GymNest</span>
        </div>
    </div>
</footer>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    document.querySelectorAll('.year').forEach(el => el.textContent = new Date().getFullYear());

    const userDropdown = document.getElementById("userDropdown");

    function updateDropdownContent(isLoggedIn, userName) {
        userDropdown.innerHTML = "";
        if (isLoggedIn) {
            userDropdown.classList.remove("d-none");
            const userLink = document.createElement("a");
            userLink.className = "nav-link dropdown-toggle";
            userLink.href = "#";
            userLink.id = "userDropdownLink";
            userLink.setAttribute("data-bs-toggle","dropdown");
            userLink.setAttribute("aria-expanded","false");
            userLink.textContent = `Hi, ${userName}`;
            userDropdown.appendChild(userLink);

            const dropdownMenu = document.createElement("ul");
            dropdownMenu.className = "dropdown-menu";
            dropdownMenu.setAttribute("aria-labelledby","userDropdownLink");
            dropdownMenu.innerHTML = `
        <li><a class="dropdown-item" href="user-profile.html">User Profile</a></li>
        <li><a class="dropdown-item active" href="user-reviews.html">My Reviews</a></li>
        <li><a class="dropdown-item text-danger" id="logoutBtn">Log out</a></li>
      `;
            userDropdown.appendChild(dropdownMenu);

            document.getElementById("logoutBtn").addEventListener("click", function(e){
                e.preventDefault();
                localStorage.clear();
                updateDropdownContent(false, "");
                window.location.href = "signin.html";
            });
        } else {
            userDropdown.classList.remove("d-none");
            const signInLink = document.createElement("a");
            signInLink.className = "nav-link";
            signInLink.href = "signin.html";
            signInLink.textContent = "Sign in/up";
            userDropdown.appendChild(signInLink);
        }
    }

    function loadUserReviews(userEmail, authToken) {
        const BASE_URL = "http://localhost:8080/api/v1/user-reviews/user/" + encodeURIComponent(userEmail);
        $.ajax({
            url: BASE_URL,
            method: "GET",
            headers: { "Authorization": `Bearer ${authToken}` },
            success: function(response) {
                const tbody = $("#userReviewsTableBody");
                tbody.empty();
                if (!response || response.length === 0) {
                    tbody.html(`<tr><td colspan="5" class="text-center">No reviews found</td></tr>`);
                    return;
                }

                response.forEach((review, index) => {
                    const stars = "★".repeat(review.rating) + "☆".repeat(5 - review.rating);
                    tbody.append(`
            <tr>
              <td>${index+1}</td>
              <td>${stars}</td>
              <td>${review.comment}</td>
              <td>${new Date(review.createdAt).toLocaleString()}</td>
              <td>
                <button class="btn btn-sm btn-outline-danger delete-review-btn" data-id="${review.reviewId}">Delete</button>
              </td>
            </tr>
          `);
                });

                $(".delete-review-btn").click(function() {
                    const reviewId = $(this).data("id");
                    if(confirm("Are you sure you want to delete this review?")) {
                        deleteReview(reviewId, authToken, userEmail);
                    }
                });
            },
            error: function() {
                $("#userReviewsTableBody").html(`<tr><td colspan="5" class="text-center text-danger">Failed to load reviews</td></tr>`);
            }
        });
    }

    function deleteReview(reviewId, token, userEmail) {
        const BASE_URL = "http://localhost:8080/api/v1/user-reviews/delete/" + reviewId;
        $.ajax({
            url: BASE_URL,
            method: "DELETE",
            headers: { "Authorization": `Bearer ${token}` },
            success: function() {
                alert("Review deleted successfully!");
                loadUserReviews(userEmail, token);
            },
            error: function() {
                alert("Failed to delete review. Try again.");
            }
        });
    }

    $(document).ready(function(){
        const name = localStorage.getItem("name");
        const token = localStorage.getItem("token");
        const email = localStorage.getItem("email");

        if (!name || !token || !email) {
            window.location.href = "signin.html";
        } else {
            updateDropdownContent(true, name);
            loadUserReviews(email, token);
        }
    });
</script>
</body>
</html>
